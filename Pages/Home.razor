@page "/"
@using System.Threading
@using System.Text.Json
@inject IJSRuntime JSRuntime

@* 視覺小說主控畫布 (Master Canvas) 
    整合功能：主選單、打字機對話系統、24格存檔系統 (12 Normal + 12 Quick)
*@

<div class="vn-container" @onclick="HandleGlobalClick" style="height: 100vh; background: #0a0a0a; color: white; user-select: none; position: relative; overflow: hidden; font-family: 'Segoe UI', Microsoft JhengHei, sans-serif;">

    @if (currentState == GameMode.MainMenu)
    {
        <!-- 1. 主選單畫面 -->
        <div class="main-menu" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('images/bg_main_menu.webp'); background-size: cover; background-position: center;">
            
            <div class="title-section" style="text-align: center; margin-bottom: 40px; animation: fadeInDown 1.5s ease-out;">
                <h1 style="font-size: 4.5rem; color: #00ffcc; text-shadow: 0 0 25px rgba(0,255,204,0.6); letter-spacing: 12px; margin: 0;">
                    宇宙邊緣的腳本家
                </h1>
                <p style="font-size: 1.2rem; color: #888; letter-spacing: 4px; margin-top: 10px;">Project: MyCSharpVN</p>
            </div>

            <div class="menu-buttons" style="display: flex; flex-direction: column; gap: 15px; width: 340px;">
                <button class="btn-menu" @onclick="StartNewGame" @onclick:stopPropagation>開始遊戲</button>
                <button class="btn-menu" @onclick="OpenSaveLoadPage" @onclick:stopPropagation>讀取進度</button>
                <button class="btn-menu" @onclick="() => SwitchState(GameMode.Settings)" @onclick:stopPropagation>遊戲設定</button>
                <button class="btn-menu" @onclick="() => SwitchState(GameMode.Gallery)" @onclick:stopPropagation>回憶畫廊</button>
                <button class="btn-menu" @onclick="QuitGame" @onclick:stopPropagation>離開遊戲</button>
            </div>
        </div>
    }
    else if (currentState == GameMode.Playing)
    {
        <!-- 2. 遊戲進行畫面 -->
        <div class="game-view" style="height: 100%; display: flex; flex-direction: column; justify-content: flex-end; background: url('images/bg_spaceship_bridge.webp'); background-size: cover; background-position: center; transition: background 1s;">
            
            <!-- 選單小按鈕 (遊戲內) -->
            <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 10px;">
                <button class="btn-small" @onclick="() => OpenSaveLoadInGame(true)" @onclick:stopPropagation>Save</button>
                <button class="btn-small" @onclick="() => OpenSaveLoadInGame(false)" @onclick:stopPropagation>Load</button>
                <button class="btn-small" @onclick="BackToMenu" @onclick:stopPropagation>Menu</button>
            </div>

            <!-- 對話顯示區 -->
            <div class="dialogue-box" style="border: 2px solid #00ffcc; margin: 35px; padding: 30px; background: rgba(0,0,0,0.88); min-height: 180px; border-radius: 12px; box-shadow: 0 0 30px rgba(0,255,204,0.2); backdrop-filter: blur(8px); position: relative;">
                
                <div class="char-name" style="color: #00ffcc; font-weight: bold; font-size: 1.6rem; margin-bottom: 15px; display: inline-block; border-bottom: 2px solid #00ffcc; padding-bottom: 5px;">
                    @currentLine.CharacterName
                </div>
                
                <div class="text-content" style="font-size: 1.5rem; line-height: 1.8; color: #e0e0e0; letter-spacing: 1.5px;">
                    @displayedText
                </div>
                
                <div class="next-indicator" style="position: absolute; bottom: 20px; right: 25px; color: #00ffcc; font-size: 0.9rem; animation: pulse 1.5s infinite;">
                    @(isTyping ? "▶ 跳過動畫" : "▼ 點擊繼續")
                </div>
            </div>
        </div>
    }
    else if (currentState == GameMode.SaveLoad)
    {
        <!-- 3. 讀取/存檔進度頁面 (24格) -->
        <div class="sub-page" style="display: flex; flex-direction: column; height: 100%; background: #050505; padding: 40px; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="color: #00ffcc; margin: 0; font-size: 2.2rem; letter-spacing: 5px;">
                    @(isSaveMode ? "保存進度" : "讀取進度")
                </h2>
                <button class="btn-menu" style="width: 150px; padding: 5px;" @onclick="BackToMenu">關閉</button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
                <!-- 左側：正式存檔 (12格) -->
                <div>
                    <h3 style="color: #888; border-bottom: 1px solid #333; padding-bottom: 10px;">NORMAL SAVE</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                        @for (int i = 1; i <= 12; i++)
                        {
                            int slot = i;
                            <div class="save-slot @(HasData(slot, false) ? "has-data" : "")" @onclick="() => HandleSlotClick(slot, false)">
                                <div class="slot-number">#@slot.ToString("D2")</div>
                                <div class="slot-info">@GetSlotLabel(slot, false)</div>
                            </div>
                        }
                    </div>
                </div>

                <!-- 右側：快速存檔 (12格) -->
                <div>
                    <h3 style="color: #00ffcc; border-bottom: 1px solid #004433; padding-bottom: 10px;">QUICK SAVE</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                        @for (int i = 1; i <= 12; i++)
                        {
                            int slot = i;
                            <div class="save-slot quick @(HasData(slot, true) ? "has-data" : "")" @onclick="() => HandleSlotClick(slot, true)">
                                <div class="slot-number">Q#@slot.ToString("D2")</div>
                                <div class="slot-info">@GetSlotLabel(slot, true)</div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- 其他子頁面 -->
        <div class="sub-page" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: #111;">
            <h2 style="color: #00ffcc; margin-bottom: 30px;">@currentState 頁面開發中...</h2>
            <button class="btn-menu" style="width: 200px;" @onclick="BackToMenu">返回主選單</button>
        </div>
    }

</div>

<style>
    .btn-menu {
        background: rgba(0, 255, 204, 0.03);
        border: 1px solid rgba(0, 255, 204, 0.4);
        color: #fff;
        padding: 14px;
        font-size: 1.25rem;
        cursor: pointer;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 2px;
        backdrop-filter: blur(4px);
        text-align: center;
    }

    .btn-menu:hover {
        background: #00ffcc;
        color: #000;
        box-shadow: 0 0 15px #00ffcc;
    }

    /* 存檔格子樣式 */
    .save-slot {
        background: #111;
        border: 1px solid #333;
        padding: 12px;
        cursor: pointer;
        transition: 0.2s;
        min-height: 60px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .save-slot:hover { border-color: #eee; background: #1a1a1a; }
    .save-slot.quick { border-color: #003322; }
    .save-slot.quick:hover { border-color: #00ffcc; background: #001100; }
    .save-slot.has-data { background: #1a1a1a; }
    
    .slot-number { font-size: 0.7rem; color: #555; margin-bottom: 4px; }
    .slot-info { font-size: 0.85rem; color: #888; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .save-slot.has-data .slot-info { color: #ccc; }

    .btn-small {
        background: rgba(0,0,0,0.6);
        border: 1px solid #00ffcc;
        color: #00ffcc;
        padding: 5px 15px;
        cursor: pointer;
        font-size: 0.9rem;
    }
    .btn-small:hover { background: #00ffcc; color: #000; }

    @@keyframes pulse {
        0% { opacity: 0.3; transform: translateY(0); }
        50% { opacity: 1; transform: translateY(-3px); }
        100% { opacity: 0.3; transform: translateY(0); }
    }

    @@keyframes fadeInDown {
        from { opacity: 0; transform: translateY(-30px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

@code {
    private enum GameMode { MainMenu, Playing, SaveLoad, Settings, Gallery }
    private GameMode currentState = GameMode.MainMenu;
    private bool isSaveMode = false; // 判斷現在是「存檔」還是「讀取」

    public class DialogueLine {
        public string CharacterName { get; set; } = "";
        public string Text { get; set; } = "";
    }

    public class SaveData {
        public int CurrentIndex { get; set; }
        public DateTime SaveTime { get; set; }
    }

    private int index = 0;
    private string displayedText = "";
    private bool isTyping = false;
    private CancellationTokenSource? cts;
    
    // 用於快取存檔狀態，避免每格都頻繁讀取 LocalStorage
    private Dictionary<string, SaveData> cachedSaves = new();

    private List<DialogueLine> script = new List<DialogueLine> {
        new DialogueLine { CharacterName = "系統", Text = "正在初始化多重存檔協議..." },
        new DialogueLine { CharacterName = "主角", Text = "這下我有 24 個格子可以用了，應該足夠攻略所有結局了吧？" },
        new DialogueLine { CharacterName = "AI 助手", Text = "是的，您可以隨時在 Normal 或 Quick 槽位之間進行管理。" },
        new DialogueLine { CharacterName = "系統", Text = "儲存機制已更新為 12x2 矩陣架構。" }
    };

    private DialogueLine currentLine => script.Count > index ? script[index] : new DialogueLine();

    // --- 存檔/讀取邏輯 ---

    private async Task OpenSaveLoadPage() {
        isSaveMode = false;
        await RefreshSaveCache();
        SwitchState(GameMode.SaveLoad);
    }

    private async Task OpenSaveLoadInGame(bool saving) {
        isSaveMode = saving;
        await RefreshSaveCache();
        SwitchState(GameMode.SaveLoad);
    }

    private async Task RefreshSaveCache() {
        cachedSaves.Clear();
        for (int i = 1; i <= 12; i++) {
            var normalJson = await JSRuntime.InvokeAsync<string>("localStorage.getItem", $"MyVN_Save_{i}");
            if (!string.IsNullOrEmpty(normalJson)) cachedSaves[$"Normal_{i}"] = JsonSerializer.Deserialize<SaveData>(normalJson)!;

            var quickJson = await JSRuntime.InvokeAsync<string>("localStorage.getItem", $"MyVN_Quick_{i}");
            if (!string.IsNullOrEmpty(quickJson)) cachedSaves[$"Quick_{i}"] = JsonSerializer.Deserialize<SaveData>(quickJson)!;
        }
    }

    private bool HasData(int slot, bool isQuick) => cachedSaves.ContainsKey($"{(isQuick ? "Quick" : "Normal")}_{slot}");

    private string GetSlotLabel(int slot, bool isQuick) {
        string key = $"{(isQuick ? "Quick" : "Normal")}_{slot}";
        if (cachedSaves.TryGetValue(key, out var data)) 
            return data.SaveTime.ToString("MM/dd HH:mm");
        return "Empty";
    }

    private async Task HandleSlotClick(int slot, bool isQuick) {
        string prefix = isQuick ? "Quick" : "Normal";
        string storageKey = $"MyVN_{prefix}_{slot}";

        if (isSaveMode) {
            // 執行存檔
            var data = new SaveData { CurrentIndex = index, SaveTime = DateTime.Now };
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", storageKey, JsonSerializer.Serialize(data));
            await RefreshSaveCache();
            Console.WriteLine($"已存檔至 {storageKey}");
        }
        else {
            // 執行讀取
            if (HasData(slot, isQuick)) {
                var data = cachedSaves[$"{prefix}_{slot}"];
                index = data.CurrentIndex;
                currentState = GameMode.Playing;
                await TypeCurrentLine();
            }
        }
    }

    // --- 遊戲邏輯 ---

    private void SwitchState(GameMode nextState) => currentState = nextState;
    private void BackToMenu() => currentState = GameMode.MainMenu;

    private async Task StartNewGame() {
        index = 0;
        currentState = GameMode.Playing;
        await TypeCurrentLine();
    }

    private async Task HandleGlobalClick() {
        if (currentState != GameMode.Playing) return;
        if (isTyping) cts?.Cancel();
        else {
            if (index < script.Count - 1) {
                index++;
                await TypeCurrentLine();
            } else BackToMenu();
        }
    }

    private async Task TypeCurrentLine() {
        string fullText = currentLine.Text;
        displayedText = "";
        isTyping = true;
        if (cts != null) { cts.Cancel(); cts.Dispose(); }
        cts = new CancellationTokenSource();
        var token = cts.Token;
        try {
            foreach (var ch in fullText) {
                if (token.IsCancellationRequested) break;
                displayedText += ch;
                StateHasChanged();
                await Task.Delay(45, token);
            }
        }
        catch (OperationCanceledException) { displayedText = fullText; }
        finally { isTyping = false; StateHasChanged(); }
    }

    private async Task QuitGame() {
        bool confirm = await JSRuntime.InvokeAsync<bool>("confirm", "確定要退出嗎？(未儲存的進度將會遺失)");
        if (confirm) await JSRuntime.InvokeVoidAsync("location.assign", "https://github.com/789jacobis/MyCSharpVN");
    }
}
