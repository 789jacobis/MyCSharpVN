@page "/"
@using System.Threading
@inject IJSRuntime JSRuntime

@* 視覺小說主控畫布 (Master Canvas) 
    整合功能：主選單、打字機對話系統、狀態切換、基礎樣式
    修正說明：調整檔案標記以確保在開發環境中正確識別，並優化非同步邏輯。
*@

<div class="vn-container" @onclick="HandleGlobalClick" style="height: 100vh; background: #0a0a0a; color: white; user-select: none; position: relative; overflow: hidden; font-family: 'Segoe UI', Microsoft JhengHei, sans-serif;">

    @if (currentState == GameMode.MainMenu)
    {
        <!-- 1. 主選單畫面 -->
        <div class="main-menu" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('images/bg_main_menu.webp'); background-size: cover; background-position: center;">
            
            <div class="title-section" style="text-align: center; margin-bottom: 60px; animation: fadeInDown 1.5s ease-out;">
                <h1 style="font-size: 4.5rem; color: #00ffcc; text-shadow: 0 0 25px rgba(0,255,204,0.6); letter-spacing: 12px; margin: 0;">
                    宇宙邊緣的腳本家
                </h1>
                <p style="font-size: 1.2rem; color: #888; letter-spacing: 4px; margin-top: 10px;">Project: MyCSharpVN</p>
            </div>

            <div class="menu-buttons" style="display: flex; flex-direction: column; gap: 18px; width: 340px;">
                <button class="btn-menu" @onclick="StartNewGame" @onclick:stopPropagation>開始遊戲</button>
                <button class="btn-menu" @onclick="() => SwitchState(GameMode.SaveLoad)" @onclick:stopPropagation>讀取進度</button>
                <button class="btn-menu" @onclick="() => SwitchState(GameMode.Settings)" @onclick:stopPropagation>遊戲設定</button>
                <button class="btn-menu" @onclick="() => SwitchState(GameMode.Gallery)" @onclick:stopPropagation>回憶畫廊</button>
                <button class="btn-menu" @onclick="QuitGame" @onclick:stopPropagation>離開遊戲</button>
            </div>
        </div>
    }
    else if (currentState == GameMode.Playing)
    {
        <!-- 2. 遊戲進行畫面 -->
        <div class="game-view" style="height: 100%; display: flex; flex-direction: column; justify-content: flex-end; background: url('images/bg_spaceship_bridge.webp'); background-size: cover; background-position: center; transition: background 1s;">
            
            <!-- 對話顯示區 -->
            <div class="dialogue-box" style="border: 2px solid #00ffcc; margin: 35px; padding: 30px; background: rgba(0,0,0,0.88); min-height: 180px; border-radius: 12px; box-shadow: 0 0 30px rgba(0,255,204,0.2); backdrop-filter: blur(8px); position: relative;">
                
                <div class="char-name" style="color: #00ffcc; font-weight: bold; font-size: 1.6rem; margin-bottom: 15px; display: inline-block; border-bottom: 2px solid #00ffcc; padding-bottom: 5px;">
                    @currentLine.CharacterName
                </div>
                
                <div class="text-content" style="font-size: 1.5rem; line-height: 1.8; color: #e0e0e0; letter-spacing: 1.5px;">
                    @displayedText
                </div>
                
                <!-- 繼續提示符號 -->
                <div class="next-indicator" style="position: absolute; bottom: 20px; right: 25px; color: #00ffcc; font-size: 0.9rem; animation: pulse 1.5s infinite;">
                    @(isTyping ? "▶ 跳過動畫" : "▼ 點擊繼續")
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- 3. 其他子頁面 (暫代畫面) -->
        <div class="sub-page" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: #111;">
            <h2 style="color: #00ffcc; margin-bottom: 30px;">@currentState 頁面開發中...</h2>
            <button class="btn-menu" style="width: 200px;" @onclick="BackToMenu">返回主選單</button>
        </div>
    }

</div>

<style>
    /* 選單按鈕樣式 */
    .btn-menu {
        background: rgba(0, 255, 204, 0.03);
        border: 1px solid rgba(0, 255, 204, 0.4);
        color: #fff;
        padding: 14px;
        font-size: 1.25rem;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        text-transform: uppercase;
        letter-spacing: 2px;
        backdrop-filter: blur(4px);
        text-align: center;
    }

    .btn-menu:hover {
        background: #00ffcc;
        color: #000;
        box-shadow: 0 0 25px #00ffcc;
        transform: translateX(10px);
        font-weight: bold;
    }

    /* 動畫效果 */
    @@keyframes pulse {
        0% { opacity: 0.3; transform: translateY(0); }
        50% { opacity: 1; transform: translateY(-3px); }
        100% { opacity: 0.3; transform: translateY(0); }
    }

    @@keyframes fadeInDown {
        from { opacity: 0; transform: translateY(-30px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

@code {
    // --- 遊戲狀態管理 ---
    private enum GameMode { MainMenu, Playing, SaveLoad, Settings, Gallery }
    private GameMode currentState = GameMode.MainMenu;

    // --- 對話系統變數 ---
    public class DialogueLine {
        public string CharacterName { get; set; } = "";
        public string Text { get; set; } = "";
    }

    private int index = 0;
    private string displayedText = "";
    private bool isTyping = false;
    private CancellationTokenSource? cts;

    // --- 測試劇本資料 ---
    private List<DialogueLine> script = new List<DialogueLine> {
        new DialogueLine { CharacterName = "系統", Text = "正在初始化科幻小說世界觀..." },
        new DialogueLine { CharacterName = "主角", Text = "這就是我的第一個 C# 視覺小說。看起來相當專業。" },
        new DialogueLine { CharacterName = "AI 助手", Text = "沒錯。現在我們已經實作了打字機效果與主選單架構。" },
        new DialogueLine { CharacterName = "主角", Text = "接下來，我們該處理「存檔系統」了吧？" }
    };

    private DialogueLine currentLine => script.Count > index ? script[index] : new DialogueLine();

    // --- 核心方法 ---

    private void SwitchState(GameMode nextState) => currentState = nextState;
    private void BackToMenu() => currentState = GameMode.MainMenu;

    // 開始新遊戲
    private async Task StartNewGame() {
        index = 0;
        currentState = GameMode.Playing;
        await TypeCurrentLine();
    }

    // 全域點擊處理 (僅在 Playing 模式有效)
    private async Task HandleGlobalClick()
    {
        if (currentState != GameMode.Playing) return;

        if (isTyping) {
            // 正在打字時點擊：直接跳過動畫，顯示全文
            cts?.Cancel();
        }
        else {
            // 打字結束後點擊：換下一行
            if (index < script.Count - 1) {
                index++;
                await TypeCurrentLine();
            } else {
                // 劇本播完返回主選單
                BackToMenu();
            }
        }
    }

    // 打字機動畫邏輯
    private async Task TypeCurrentLine()
    {
        string fullText = currentLine.Text;
        displayedText = "";
        isTyping = true;

        // 取消先前的打字任務
        if (cts != null)
        {
            cts.Cancel();
            cts.Dispose();
        }
        
        cts = new CancellationTokenSource();
        var token = cts.Token;

        try {
            foreach (var ch in fullText) {
                if (token.IsCancellationRequested) break;
                displayedText += ch;
                StateHasChanged(); // 強制更新畫面
                await Task.Delay(45, token); // 控制打字速度 (ms)
            }
        }
        catch (OperationCanceledException) {
            // 被取消時直接顯示全文
            displayedText = fullText;
        }
        finally {
            isTyping = false;
            StateHasChanged();
        }
    }

    // 離開遊戲
    private async Task QuitGame() {
        bool confirm = await JSRuntime.InvokeAsync<bool>("confirm", "確定要退出遊戲並返回 GitHub 嗎？");
        if (confirm) {
            await JSRuntime.InvokeVoidAsync("location.assign", "https://github.com/789jacobis/MyCSharpVN");
        }
    }
}
