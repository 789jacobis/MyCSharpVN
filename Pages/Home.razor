@page "/"
@using System.Threading
@using System.Net.Http
@using System.Text.Json
@using System.Linq
@inject IJSRuntime JSRuntime
@inject HttpClient Http

@* è¦–è¦ºå°èªªä¸»æ§ç•«å¸ƒ - ç´”æ–‡å­—è…³æœ¬ (TXT Parser) ç‰ˆ
   æ›´æ–°å…§å®¹ï¼š
   1. ç§»é™¤ JSON è®€å–ï¼Œæ”¹ç‚ºè®€å– data/script.txt ä¸¦ç”± ParseScript è§£æå…¨ä¸­æ–‡æ¨™ç±¤ã€‚
   2. åŠ‡æœ¬æ¨¡å‹ (DialogueLine) ç›´æ¥å¿«ç…§æ¯å€‹æ™‚åˆ»çš„èƒŒæ™¯èˆ‡ä¸‰ä½ç«‹ç¹ªç‹€æ…‹ã€‚
   3. ç°¡åŒ–å­˜æª”ç³»çµ±ï¼Œåªéœ€å­˜ Index å³å¯å®Œç¾é‚„åŸæ‰€æœ‰å ´æ™¯ç‹€æ…‹ã€‚
*@

<div class="vn-container" @onclick="HandleGlobalClick" style="height: 100vh; background: #000; color: white; user-select: none; position: relative; overflow: hidden; font-family: 'Segoe UI', Microsoft JhengHei, sans-serif;">

    @if (currentState == GameMode.MainMenu)
    {
        <div class="main-menu" style="position: absolute; top:0; left:0; width:100%; height:100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10;">
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #001133 0%, #000000 100%); z-index: -1;"></div>
            
            <div class="title-section" style="text-align: center; margin-bottom: 50px; z-index: 2;">
                <h1 style="font-size: 4rem; color: #00ffcc; text-shadow: 0 0 20px rgba(0,255,204,0.5); letter-spacing: 10px;">
                    å®‡å®™é‚Šç·£çš„è…³æœ¬å®¶
                </h1>
                <p style="color: #888; letter-spacing: 3px;">Project MyCSharpVN - TXT Engine</p>
            </div>
            <div class="menu-buttons" style="display: flex; flex-direction: column; gap: 12px; width: 300px; z-index: 2;">
                <button class="btn-menu" @onclick="StartNewGame" @onclick:stopPropagation>é–‹å§‹éŠæˆ²</button>
                <button class="btn-menu" @onclick="() => OpenSaveLoadPage(false)" @onclick:stopPropagation>è®€å–é€²åº¦</button>
                <button class="btn-menu" @onclick="() => SwitchState(GameMode.Settings)" @onclick:stopPropagation>éŠæˆ²è¨­å®š</button>
                <button class="btn-menu" @onclick="QuitGame" @onclick:stopPropagation>é›¢é–‹éŠæˆ²</button>
            </div>
        </div>
    }
    else if (currentState == GameMode.Playing)
    {
        <div class="game-view capture-target" style="height: 100%; width: 100%; position: relative; background-color: #000;">
            
            <!-- å‹•æ…‹èƒŒæ™¯åœ–å±¤ -->
            <div class="bg-layer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, #001122, #000); z-index: 0;">
                @if (!string.IsNullOrEmpty(currentBgImage))
                {
                    <img @key="currentBgImage" src="@currentBgImage" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; animation: fadeInBg 1s ease-in-out;" />
                }
            </div>
            
            <!-- å¤šé‡ç«‹ç¹ªå±¤ -->
            <div class="sprite-wrapper">
                @if (!string.IsNullOrEmpty(spriteLeft))
                {
                    <img @key="spriteLeft" src="@spriteLeft" class="sprite-img pos-left" />
                }
                @if (!string.IsNullOrEmpty(spriteCenter))
                {
                    <img @key="spriteCenter" src="@spriteCenter" class="sprite-img pos-center" />
                }
                @if (!string.IsNullOrEmpty(spriteRight))
                {
                    <img @key="spriteRight" src="@spriteRight" class="sprite-img pos-right" />
                }
            </div>

            <!-- é¸é …ä»‹é¢ -->
            @if (currentLine.Choices != null && currentLine.Choices.Any() && !isTyping && !showLog)
            {
                <div class="choices-container" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); z-index: 150;">
                    @foreach (var choice in currentLine.Choices)
                    {
                        <button class="btn-choice" @onclick="() => MakeChoice(choice)" @onclick:stopPropagation>@choice.Text</button>
                    }
                </div>
            }

            <!-- æ­·å²å°è©±ç´€éŒ„ -->
            @if (showLog)
            {
                <div class="log-overlay" @onclick="ToggleLog" @onclick:stopPropagation style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 200; display: flex; flex-direction: column; padding: 40px;">
                    <h2 style="color: #00ffcc; margin-bottom: 20px; text-align: center; letter-spacing: 5px;">æ­·å²å°è©±ç´€éŒ„ (BACKLOG)</h2>
                    
                    <div class="log-content custom-scrollbar" @onclick:stopPropagation style="flex-grow: 1; overflow-y: auto; padding-right: 20px; display: flex; flex-direction: column; gap: 15px;">
                        @foreach (var logLine in historyLog)
                        {
                            <div class="log-item" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; border-left: 4px solid #00ffcc;">
                                <div style="color: #00ffcc; font-weight: bold; font-size: 1.1rem; margin-bottom: 5px;">@logLine.CharacterName</div>
                                <div style="color: #eee; font-size: 1.2rem; line-height: 1.5;">@logLine.Text</div>
                            </div>
                        }
                        @if (historyLog.Count == 0)
                        {
                            <div style="text-align: center; color: #888; margin-top: 50px; font-style: italic;">å°šç„¡å°è©±ç´€éŒ„...</div>
                        }
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn-menu" @onclick="ToggleLog" @onclick:stopPropagation style="width: 200px;">è¿”å›éŠæˆ²</button>
                    </div>
                </div>
            }

            <!-- å°è©±æ¡† -->
            @if (!showLog)
            {
                <div class="dialogue-box" style="position: absolute; bottom: 50px; left: 5%; width: 90%; border: 3px solid #00ffcc; padding: 25px; background-color: rgba(10, 10, 10, 0.95); border-radius: 10px; min-height: 160px; z-index: 99;">
                    
                    <div class="game-hud" style="position: absolute; top: -35px; right: 0; display: flex; gap: 5px; z-index: 100;">
                        <button class="btn-hud" @onclick="ToggleLog" @onclick:stopPropagation>Log</button>
                        <button class="btn-hud" @onclick="() => OpenSaveLoadInGame(true, false)" @onclick:stopPropagation>Save</button>
                        <button class="btn-hud" @onclick="PerformQuickSave" @onclick:stopPropagation>Q.Save</button>
                        <button class="btn-hud" @onclick="() => OpenSaveLoadInGame(false, false)" @onclick:stopPropagation>Load</button>
                        <button class="btn-hud" @onclick="PerformQuickLoad" @onclick:stopPropagation>Q.Load</button>
                        <button class="btn-hud" @onclick="BackToMenu" @onclick:stopPropagation>Menu</button>
                    </div>

                    <div class="char-name" style="color: #00ffcc; font-size: 1.4rem; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #333; display: inline-block;">
                        @currentLine.CharacterName
                    </div>
                    
                    <div class="text-content" style="font-size: 1.3rem; line-height: 1.6; color: #fff;">
                        @displayedText
                    </div>
                    
                    <div class="next-indicator" style="position: absolute; bottom: 15px; right: 20px; color: #00ffcc; font-size: 0.9rem;">
                        @if (currentLine.Choices != null && currentLine.Choices.Any()) {
                            <span>...</span>
                        } else {
                            @(isTyping ? "â–¶" : "â–¼")
                        }
                    </div>
                </div>
            }
        </div>
    }
    else if (currentState == GameMode.SaveLoad)
    {
        <div class="sub-page" @onclick:stopPropagation style="position: absolute; top:0; left:0; width:100%; height:100%; background: #050505; padding: 30px; display: flex; flex-direction: column; z-index: 999; overflow-x: hidden;">
            <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 25px; position: relative;">
                <div style="position: absolute; left: 0; color: #00ffcc; font-size: 1.2rem; font-weight: bold; letter-spacing: 2px;">
                    @(isSaveMode ? "å­˜æª”æ¨¡å¼ (SAVE)" : "è®€å–æ¨¡å¼ (LOAD)")
                </div>
                <div class="tab-group" style="display: flex; background: #111; padding: 5px; border-radius: 25px; border: 1px solid #333;">
                    <button class="tab-btn @(!isViewingQuickSave ? "active" : "")" @onclick="() => isViewingQuickSave = false">NORMAL</button>
                    <button class="tab-btn @(isViewingQuickSave ? "active" : "")" @onclick="() => isViewingQuickSave = true">QUICK</button>
                </div>
                <button class="btn-close" style="position: absolute; right: 0;" @onclick="CloseSubPage">âœ•</button>
            </div>
            <div class="save-grid custom-scrollbar" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; flex-grow: 1; overflow-y: auto; overflow-x: hidden; padding: 20px;">
                @for (int i = 1; i <= 12; i++)
                {
                    int slot = i;
                    var data = GetSlotData(slot, isViewingQuickSave);
                    bool isForbidden = isSaveMode && isViewingQuickSave;
                    <div class="save-card @(data != null ? "has-data" : "") @(isForbidden ? "forbidden" : "")" @onclick="() => HandleSlotClick(slot, isViewingQuickSave)">
                        <div class="card-header">
                            <span>@(isViewingQuickSave ? "Q" : "")@slot.ToString("D3")</span>
                            <span class="card-time">@(data?.SaveTime.ToString("yyyy/MM/dd HH:mm:ss") ?? "------")</span>
                        </div>
                        <div class="card-thumb" style="background-color: #222; background-image: url('@(data?.Thumbnail ?? "")'); background-size: cover; background-position: center;">
                            @if (data == null) { <div class="empty-txt">NO DATA</div> }
                            @if (isForbidden) { <div class="forbidden-overlay"><span style="font-size: 2rem;">ğŸš«</span><br>AUTO ONLY</div> }
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

<style>
    @@keyframes fadeInBg { from { opacity: 0.3; } to { opacity: 1; } }

    .sprite-wrapper { position: absolute; bottom: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
    .sprite-img { 
        position: absolute; 
        bottom: 0; 
        max-height: 85vh; 
        width: auto; 
        filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); 
        animation: fadeInSprite 0.5s ease-out; 
    }
    .pos-left { left: 5%; }
    .pos-center { left: 50%; transform: translateX(-50%); }
    .pos-right { right: 5%; }

    @@keyframes fadeInSprite {
        from { opacity: 0; margin-bottom: -30px; }
        to { opacity: 1; margin-bottom: 0; }
    }

    .btn-close { background: rgba(255, 255, 255, 0.1); border: 2px solid #888; color: #fff; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; transition: 0.3s; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
    .btn-close:hover { border-color: #ff3333; background: rgba(255, 51, 51, 0.2); color: #ff3333; transform: rotate(90deg) scale(1.1); box-shadow: 0 0 15px rgba(255,51,51,0.5); }
    .btn-choice { background: rgba(0, 0, 0, 0.8); border: 2px solid #00ffcc; color: #fff; padding: 15px 40px; margin: 10px; font-size: 1.2rem; border-radius: 8px; cursor: pointer; transition: 0.3s; min-width: 400px; text-align: center; letter-spacing: 2px; }
    .btn-choice:hover { background: #00ffcc; color: #000; box-shadow: 0 0 20px rgba(0,255,204,0.8); transform: scale(1.05); font-weight: bold; }
    .custom-scrollbar::-webkit-scrollbar { width: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #0a0a0a; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #00ffcc; border-radius: 4px; border: 2px solid #0a0a0a; }
    .btn-menu { background: rgba(0,255,204,0.05); border: 1px solid #00ffcc; color: #fff; padding: 12px; cursor: pointer; transition: 0.3s; letter-spacing: 2px; }
    .btn-menu:hover { background: #00ffcc; color: #000; box-shadow: 0 0 15px #00ffcc; }
    .btn-hud { background: rgba(0,0,0,0.8); border: 1px solid #00ffcc; color: #00ffcc; padding: 4px 10px; font-size: 0.8rem; cursor: pointer; }
    .btn-hud:hover { background: #00ffcc; color: #000; }
    .tab-btn { background: transparent; border: none; color: #666; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; }
    .tab-btn.active { background: #00ffcc; color: #000; font-weight: bold; }
    .save-card { background: #111; border: 1px solid #333; border-radius: 8px; overflow: hidden; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; position: relative; }
    .save-card:not(.forbidden):hover { border-color: #00ffcc; transform: scale(1.02); z-index: 10; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
    .card-header { font-size: 0.7rem; padding: 4px 8px; background: #1a1a1a; display: flex; justify-content: space-between; color: #555; }
    .card-thumb { aspect-ratio: 16/9; display: flex; align-items: center; justify-content: center; background: #000; position: relative; }
</style>

@code {
    public enum GameMode { MainMenu, Playing, SaveLoad, Settings }

    private GameMode currentState = GameMode.MainMenu;
    private GameMode previousState = GameMode.MainMenu;
    private bool isSaveMode = false;
    private bool isViewingQuickSave = false;
    private bool showLog = false;
    
    private string currentBgImage = "";
    private string spriteLeft = "";
    private string spriteCenter = "";
    private string spriteRight = "";

    private List<LogEntry> historyLog = new();
    private int textSpeed = 40;
    private int index = 0;
    private string displayedText = "";
    private string tempThumbnail = ""; 
    private bool isTyping = false;
    private CancellationTokenSource? cts;
    private Dictionary<string, SaveData> cachedSaves = new();

    public class Choice {
        public string Text { get; set; } = "";
        public string TargetId { get; set; } = "";
    }

    public class DialogueLine { 
        public string Id { get; set; } = "";
        public string CharacterName { get; set; } = ""; 
        public string Text { get; set; } = ""; 
        public string BackgroundImage { get; set; } = ""; 
        public string SpriteLeft { get; set; } = "";
        public string SpriteCenter { get; set; } = "";
        public string SpriteRight { get; set; } = "";
        public List<Choice>? Choices { get; set; }
    }

    public class SaveData { 
        public int CurrentIndex { get; set; } 
        public string LineId { get; set; } = "";
        public DateTime SaveTime { get; set; } 
        public string Thumbnail { get; set; } = ""; 
        public List<LogEntry> SavedLog { get; set; } = new();
    }

    public class LogEntry {
        public string CharacterName { get; set; } = "";
        public string Text { get; set; } = "";
    }

    private List<DialogueLine> script = new();
    private DialogueLine currentLine => script.Count > index ? script[index] : new DialogueLine { CharacterName = "ç³»çµ±", Text = "åŠ‡æœ¬è¼‰å…¥ä¸­..." };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // è®€å–ç´”æ–‡å­—åŠ‡æœ¬
            var textData = await Http.GetStringAsync("data/script.txt");
            ParseScript(textData);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"è®€å–åŠ‡æœ¬å¤±æ•—: {ex.Message}");
            script = new List<DialogueLine> { new DialogueLine { CharacterName = "Error", Text = "ç„¡æ³•è®€å–åŠ‡æœ¬æª”æ¡ˆ (data/script.txt)ã€‚è«‹ç¢ºèªæª”æ¡ˆæ˜¯å¦å­˜åœ¨ã€‚" } };
        }
    }

    // å°‡ç´”æ–‡å­—è½‰åŒ–ç‚ºéŠæˆ²é‚è¼¯çš„è§£æå™¨
    private void ParseScript(string rawText)
    {
        script.Clear();
        var lines = rawText.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries);
        
        string pendingId = "";
        string curBg = "";
        string curSpriteL = "";
        string curSpriteC = "";
        string curSpriteR = "";

        foreach (var rawLine in lines)
        {
            var line = rawLine.Trim();
            if (string.IsNullOrEmpty(line) || line.StartsWith("//")) continue;

            if (line.StartsWith("#"))
            {
                pendingId = line.Substring(1).Trim();
            }
            else if (line.StartsWith("[èƒŒæ™¯]"))
            {
                curBg = line.Substring(4).Trim();
            }
            else if (line.StartsWith("[æ¸…å ´]"))
            {
                curSpriteL = ""; curSpriteC = ""; curSpriteR = "";
            }
            else if (line.StartsWith("[ç«‹ç¹ª]"))
            {
                var parts = line.Substring(4).Trim().Split(new[] { ' ' }, 2, StringSplitOptions.RemoveEmptyEntries);
                if (parts.Length == 2)
                {
                    var pos = parts[0];
                    var img = parts[1];
                    if (img.ToLower() == "none" || img == "ç„¡" || img == "clear") img = "";

                    if (pos == "å·¦") curSpriteL = img;
                    else if (pos == "ä¸­") curSpriteC = img;
                    else if (pos == "å³") curSpriteR = img;
                }
            }
            else if (line.StartsWith("[é¸é …]"))
            {
                // æ ¼å¼ï¼š [é¸é …] æ–‡å­— -> ç›®æ¨™ID
                var content = line.Substring(4).Trim();
                var parts = content.Split(new[] { "->" }, StringSplitOptions.None);
                if (parts.Length == 2 && script.Any())
                {
                    var choice = new Choice { Text = parts[0].Trim(), TargetId = parts[1].Trim() };
                    var lastLine = script.Last();
                    if (lastLine.Choices == null) lastLine.Choices = new List<Choice>();
                    lastLine.Choices.Add(choice);
                }
            }
            else
            {
                // è§£æå°è©± (æ”¯æ´å…¨å½¢æˆ–åŠå½¢å†’è™Ÿ)
                int colonIndex = line.IndexOf('ï¼š');
                if (colonIndex == -1) colonIndex = line.IndexOf(':');

                string name = "", text = line;
                if (colonIndex != -1)
                {
                    name = line.Substring(0, colonIndex).Trim();
                    text = line.Substring(colonIndex + 1).Trim();
                }

                // å°‡ç•¶ä¸‹çš„èƒŒæ™¯èˆ‡ç«‹ç¹ªç‹€æ…‹ã€Œæ‹ç…§ã€å­˜å…¥é€™ä¸€å¥å°ç™½ä¸­
                var newLine = new DialogueLine {
                    Id = string.IsNullOrEmpty(pendingId) ? Guid.NewGuid().ToString() : pendingId,
                    CharacterName = name,
                    Text = text,
                    BackgroundImage = curBg,
                    SpriteLeft = curSpriteL,
                    SpriteCenter = curSpriteC,
                    SpriteRight = curSpriteR
                };

                script.Add(newLine);
                pendingId = ""; // ç”¨å®Œ ID å¾Œæ¸…ç©º
            }
        }
        
        if (!script.Any()) {
            script.Add(new DialogueLine { CharacterName = "ç³»çµ±", Text = "åŠ‡æœ¬è§£æç‚ºç©ºï¼Œè«‹æª¢æŸ¥æ ¼å¼ã€‚" });
        }
    }

    private void ToggleLog()
    {
        if (currentState == GameMode.Playing && !isTyping) showLog = !showLog;
    }

    private async Task OpenSaveLoadPage(bool viewingQuick) {
        previousState = currentState; isSaveMode = false; isViewingQuickSave = viewingQuick;
        await RefreshSaveCache(); currentState = GameMode.SaveLoad;
    }

    private async Task OpenSaveLoadInGame(bool saving, bool viewingQuick) {
        if (currentState == GameMode.Playing) {
            try { StateHasChanged(); await Task.Delay(300); tempThumbnail = await JSRuntime.InvokeAsync<string>("captureThumbnail", ".capture-target"); } catch { tempThumbnail = ""; }
        }
        previousState = currentState; isSaveMode = saving; isViewingQuickSave = viewingQuick;
        await RefreshSaveCache(); currentState = GameMode.SaveLoad;
    }

    private void CloseSubPage() => currentState = previousState;

    private async Task HandleSlotClick(int slot, bool isQuick) {
        if (isSaveMode && isQuick) return; 
        string key = $"MyVN_{(isQuick ? "Quick" : "Normal")}_{slot}";
        if (isSaveMode) await ExecuteSave(key); else await ExecuteLoad(key.Replace("MyVN_", ""));
    }

    private async Task ExecuteSave(string storageKey) {
        string thumb = currentState == GameMode.Playing ? "" : tempThumbnail;
        if (currentState == GameMode.Playing) {
             try { StateHasChanged(); await Task.Delay(300); thumb = await JSRuntime.InvokeAsync<string>("captureThumbnail", ".capture-target"); } catch { }
        }
        try {
            var data = new SaveData { CurrentIndex = index, LineId = currentLine.Id, SaveTime = DateTime.Now, Thumbnail = thumb, SavedLog = historyLog.ToList() };
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", storageKey, JsonSerializer.Serialize(data));
            await RefreshSaveCache();
        } catch { }
    }

    private async Task ExecuteLoad(string cacheKey) {
        if (cachedSaves.TryGetValue(cacheKey, out var data)) {
            int targetIndex = data.CurrentIndex;
            if (!string.IsNullOrEmpty(data.LineId)) {
                var foundIndex = script.FindIndex(s => s.Id == data.LineId);
                if (foundIndex != -1) targetIndex = foundIndex;
            }
            index = targetIndex;
            displayedText = currentLine.Text;
            historyLog = data.SavedLog ?? new List<LogEntry>();
            isTyping = false; showLog = false; currentState = GameMode.Playing;
            
            // ç”±æ–¼æ¯å€‹ DialogueLine éƒ½è‡ªå¸¶ç«‹ç¹ªèˆ‡èƒŒæ™¯ç‹€æ…‹ï¼Œè®€æª”æ™‚å‘¼å« TypeCurrentLine å°±æœƒå®Œç¾é‚„åŸç•«é¢
            _ = TypeCurrentLine();
        }
    }

    private async Task PerformQuickSave() {
        await RefreshSaveCache();
        int targetSlot = -1;
        for (int i = 1; i <= 12; i++) { if (!HasData(i, true)) { targetSlot = i; break; } }
        if (targetSlot == -1) {
            DateTime oldest = DateTime.MaxValue;
            for (int i = 1; i <= 12; i++) {
                var d = GetSlotData(i, true);
                if (d != null && d.SaveTime < oldest) { oldest = d.SaveTime; targetSlot = i; }
            }
        }
        if (targetSlot != -1) await ExecuteSave($"MyVN_Quick_{targetSlot}");
    }

    private async Task PerformQuickLoad() {
        await RefreshSaveCache();
        DateTime newest = DateTime.MinValue;
        int targetSlot = -1;
        for (int i = 1; i <= 12; i++) {
            var d = GetSlotData(i, true);
            if (d != null && d.SaveTime > newest) { newest = d.SaveTime; targetSlot = i; }
        }
        if (targetSlot != -1) await ExecuteLoad($"Quick_{targetSlot}");
    }

    private async Task RefreshSaveCache() {
        cachedSaves.Clear();
        for (int i = 1; i <= 12; i++) {
            var n = await JSRuntime.InvokeAsync<string>("localStorage.getItem", $"MyVN_Normal_{i}");
            if (!string.IsNullOrEmpty(n)) cachedSaves[$"Normal_{i}"] = JsonSerializer.Deserialize<SaveData>(n)!;
            var q = await JSRuntime.InvokeAsync<string>("localStorage.getItem", $"MyVN_Quick_{i}");
            if (!string.IsNullOrEmpty(q)) cachedSaves[$"Quick_{i}"] = JsonSerializer.Deserialize<SaveData>(q)!;
        }
    }

    private SaveData? GetSlotData(int slot, bool isQuick) => cachedSaves.GetValueOrDefault($"{(isQuick ? "Quick" : "Normal")}_{slot}");
    private bool HasData(int slot, bool isQuick) => cachedSaves.ContainsKey($"{(isQuick ? "Quick" : "Normal")}_{slot}");

    private async Task StartNewGame() { 
        index = 0; historyLog.Clear(); showLog = false; currentState = GameMode.Playing; await TypeCurrentLine(); 
    }
    private void BackToMenu() => currentState = GameMode.MainMenu;
    private void SwitchState(GameMode s) { previousState = currentState; currentState = s; }

    private async Task HandleGlobalClick() {
        if (currentState != GameMode.Playing || showLog) return;
        if (isTyping) { cts?.Cancel(); }
        else {
            if (currentLine.Choices != null && currentLine.Choices.Any()) return;
            GoToNextLine("");
        }
    }

    private void MakeChoice(Choice choice) {
        historyLog.Add(new LogEntry { CharacterName = "æŒ‡æ®å®˜ (ä½ )", Text = $"[{choice.Text}]" });
        GoToNextLine(choice.TargetId);
    }

    private void GoToNextLine(string targetId) {
        if (!string.IsNullOrWhiteSpace(currentLine.Text) && string.IsNullOrEmpty(currentLine.CharacterName) == false) {
            historyLog.Add(new LogEntry { CharacterName = currentLine.CharacterName, Text = currentLine.Text });
            if (historyLog.Count > 100) historyLog.RemoveAt(0);
        }

        if (!string.IsNullOrEmpty(targetId)) {
            var nextIndex = script.FindIndex(l => l.Id == targetId);
            index = nextIndex != -1 ? nextIndex : index + 1;
        } else {
            index++;
        }

        if (index < script.Count) _ = TypeCurrentLine(); else BackToMenu();
    }

    private async Task TypeCurrentLine() {
        // ç›´æ¥å¾è©²å¥è…³æœ¬è®€å–ç•¶ä¸‹è©²æœ‰çš„èƒŒæ™¯èˆ‡ç«‹ç¹ªï¼Œè®“ç‹€æ…‹å®Œç¾åŒæ­¥ä¸”ä¸æ¼æ¥
        currentBgImage = currentLine.BackgroundImage;
        spriteLeft = currentLine.SpriteLeft;
        spriteCenter = currentLine.SpriteCenter;
        spriteRight = currentLine.SpriteRight;

        string fullText = currentLine.Text;
        displayedText = ""; isTyping = true;
        cts?.Cancel(); cts = new();
        try {
            foreach (var ch in fullText) {
                displayedText += ch; StateHasChanged();
                await Task.Delay(textSpeed, cts.Token);
            }
        } catch { displayedText = fullText; } finally { isTyping = false; StateHasChanged(); }
    }

    private async Task QuitGame() => await JSRuntime.InvokeVoidAsync("location.assign", "https://github.com/");
}
