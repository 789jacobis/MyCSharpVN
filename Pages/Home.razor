@page "/"
@using System.Threading
@using System.Text.Json
@inject IJSRuntime JSRuntime

<div class="vn-container" @onclick="HandleGlobalClick" style="height: 100vh; background: #0a0a0a; color: white; user-select: none; position: relative; overflow: hidden; font-family: 'Segoe UI', Microsoft JhengHei, sans-serif;">

    @if (currentState == GameMode.MainMenu)
    {
        <!-- 1. ä¸»é¸å–® (ç¶­æŒåŸæ¨£) -->
        <div class="main-menu" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('images/bg_main_menu.webp'); background-size: cover; background-position: center;">
            <div class="title-section" style="text-align: center; margin-bottom: 50px;">
                <h1 style="font-size: 4rem; color: #00ffcc; text-shadow: 0 0 20px rgba(0,255,204,0.5); letter-spacing: 10px;">
                    å®‡å®™é‚Šç·£çš„è…³æœ¬å®¶
                </h1>
                <p style="color: #888; letter-spacing: 3px;">Project MyCSharpVN - Final Fix</p>
            </div>
            <div class="menu-buttons" style="display: flex; flex-direction: column; gap: 12px; width: 300px;">
                <button class="btn-menu" @onclick="StartNewGame" @onclick:stopPropagation>é–‹å§‹éŠæˆ²</button>
                <button class="btn-menu" @onclick="() => OpenSaveLoadPage(false)" @onclick:stopPropagation>è®€å–é€²åº¦</button>
                <button class="btn-menu" @onclick="() => SwitchState(GameMode.Settings)" @onclick:stopPropagation>éŠæˆ²è¨­å®š</button>
                <button class="btn-menu" @onclick="QuitGame" @onclick:stopPropagation>é›¢é–‹éŠæˆ²</button>
            </div>
        </div>
    }
    else if (currentState == GameMode.Playing)
    {
        <!-- 2. éŠæˆ²é€²è¡Œç•«é¢ (capture-target)
             ä¿®æ­£ï¼šä½¿ç”¨ç´” CSS æ·±è—è‰²æ¼¸å±¤ï¼Œç¢ºä¿èƒŒæ™¯ä¸æ˜¯å…¨é»‘ -->
        <div class="game-view capture-target" style="height: 100%; display: flex; flex-direction: column; justify-content: flex-end; background: radial-gradient(circle at center, #1a2a6c, #b21f1f, #fdbb2d) !important; background: linear-gradient(to bottom, #020024 0%, #090979 35%, #00d4ff 100%);">
            
            <!-- å°è©±æ¡†ä¿®æ­£ï¼š
                 1. z-index: 10 (ç¢ºä¿åœ¨æœ€ä¸Šå±¤)
                 2. background: #050505 (ç´”è‰²ä¸é€æ˜ï¼Œç¢ºä¿æˆªåœ–å¯è¦‹)
            -->
            <div class="dialogue-box" style="z-index: 10; border: 3px solid #00ffcc; margin: 40px; padding: 25px; background: #050505; border-radius: 15px; position: relative; min-height: 160px; box-shadow: 0 0 0px transparent;">
                
                <div class="game-hud" style="position: absolute; top: -45px; right: 0; display: flex; gap: 5px; z-index: 20;">
                    <button class="btn-hud" @onclick="() => OpenSaveLoadInGame(true, false)" @onclick:stopPropagation>Save</button>
                    <button class="btn-hud" @onclick="PerformQuickSave" @onclick:stopPropagation>Q.Save</button>
                    <button class="btn-hud" @onclick="() => OpenSaveLoadInGame(false, false)" @onclick:stopPropagation>Load</button>
                    <button class="btn-hud" @onclick="PerformQuickLoad" @onclick:stopPropagation>Q.Load</button>
                    <button class="btn-hud" @onclick="BackToMenu" @onclick:stopPropagation>Menu</button>
                </div>

                <div class="char-name" style="color: #00ffcc; font-size: 1.4rem; font-weight: bold; margin-bottom: 10px;">@currentLine.CharacterName</div>
                <div class="text-content" style="font-size: 1.3rem; line-height: 1.6; color: #ffffff;">@displayedText</div>
                
                <div class="next-indicator" style="position: absolute; bottom: 20px; right: 25px; color: #00ffcc; font-size: 0.9rem;">
                    @(isTyping ? "â–¶" : "â–¼")
                </div>
            </div>
        </div>
    }
    else if (currentState == GameMode.SaveLoad)
    {
        <!-- 3. è®€å–/å­˜æª”é é¢ -->
        <div class="sub-page" @onclick:stopPropagation style="height: 100%; background: #050505; padding: 30px; display: flex; flex-direction: column; z-index: 999;">
            
            <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 25px; position: relative;">
                <div style="position: absolute; left: 0; color: #00ffcc; font-size: 1.2rem; font-weight: bold; letter-spacing: 2px;">
                    @(isSaveMode ? "å­˜æª”æ¨¡å¼ (SAVE)" : "è®€å–æ¨¡å¼ (LOAD)")
                </div>

                <div class="tab-group" style="display: flex; background: #111; padding: 5px; border-radius: 25px; border: 1px solid #333;">
                    <button class="tab-btn @(!isViewingQuickSave ? "active" : "")" @onclick="() => isViewingQuickSave = false">NORMAL</button>
                    <button class="tab-btn @(isViewingQuickSave ? "active" : "")" @onclick="() => isViewingQuickSave = true">QUICK</button>
                </div>
                <button class="btn-close" style="position: absolute; right: 0;" @onclick="CloseSubPage">âœ•</button>
            </div>

            <div class="save-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; flex-grow: 1; overflow-y: auto;">
                @for (int i = 1; i <= 12; i++)
                {
                    int slot = i;
                    var data = GetSlotData(slot, isViewingQuickSave);
                    bool isForbidden = isSaveMode && isViewingQuickSave;

                    <div class="save-card @(data != null ? "has-data" : "") @(isForbidden ? "forbidden" : "")" 
                         @onclick="() => HandleSlotClick(slot, isViewingQuickSave)">
                        
                        <div class="card-header">
                            <span>@(isViewingQuickSave ? "Q" : "")@slot.ToString("D3")</span>
                            <span class="card-time">@(data?.SaveTime.ToString("yyyy/MM/dd HH:mm:ss") ?? "------")</span>
                        </div>
                        
                        <div class="card-thumb" style="background-image: url('@(data?.Thumbnail ?? "")'); background-size: cover; background-position: center;">
                            @if (data == null) { <div class="empty-txt">NO DATA</div> }
                            @if (isForbidden) { <div class="forbidden-overlay"><span style="font-size: 2rem;">ğŸš«</span><br>AUTO ONLY</div> }
                        </div>
                    </div>
                }
            </div>
        </div>
    }
    else if (currentState == GameMode.Settings) 
    {
        <!-- è¨­å®šé é¢ -->
        <div class="sub-page" @onclick:stopPropagation style="height: 100%; background: #050505; padding: 40px; display: flex; flex-direction: column;">
             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
                <h2 style="color: #00ffcc; letter-spacing: 5px; margin: 0;">GAME SETTINGS</h2>
                <button class="btn-menu" style="width: 120px; padding: 5px;" @onclick="CloseSubPage">Close</button>
            </div>
             <div class="setting-group" style="color:white; border: 1px solid #333; padding: 20px; border-radius: 10px;">
                <label style="display:block; margin-bottom: 10px;">æ–‡å­—é¡¯ç¤ºé€Ÿåº¦: @textSpeed ms</label>
                <input type="range" min="10" max="100" @bind="textSpeed" style="width: 100%; accent-color: #00ffcc;" />
            </div>
        </div>
    }
</div>

<style>
    .btn-menu { background: rgba(0,255,204,0.05); border: 1px solid #00ffcc; color: #fff; padding: 12px; cursor: pointer; transition: 0.3s; letter-spacing: 2px; }
    .btn-menu:hover { background: #00ffcc; color: #000; box-shadow: 0 0 15px #00ffcc; }
    
    .btn-hud { background: rgba(0,0,0,0.8); border: 1px solid #00ffcc; color: #00ffcc; padding: 4px 10px; font-size: 0.8rem; cursor: pointer; }
    .btn-hud:hover { background: #00ffcc; color: #000; }

    .tab-btn { background: transparent; border: none; color: #666; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; transition: 0.3s; }
    .tab-btn.active { background: #00ffcc; color: #000; font-weight: bold; }
    
    .save-card { background: #111; border: 1px solid #333; border-radius: 8px; overflow: hidden; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; position: relative; }
    .save-card:not(.forbidden):hover { border-color: #00ffcc; transform: scale(1.02); z-index: 10; }
    
    .save-card.forbidden { cursor: not-allowed; opacity: 0.7; border-color: #330000; }
    .forbidden-overlay { position: absolute; top:0; left:0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; flex-direction: column; align-items: center; justify-content: center; color: #ff5555; font-weight: bold; font-size: 0.8rem; }

    .card-header { font-size: 0.7rem; padding: 4px 8px; background: #1a1a1a; display: flex; justify-content: space-between; color: #555; }
    .card-thumb { aspect-ratio: 16/9; display: flex; align-items: center; justify-content: center; background: #000; position: relative; }
    .empty-txt { color: #333; font-weight: bold; letter-spacing: 1px; }
    .has-data .card-header { color: #00ffcc; }
    
    .btn-close { background: none; border: 1px solid #444; color: #888; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; transition: 0.3s; }
    .btn-close:hover { border-color: #ff3333; color: #ff3333; transform: rotate(90deg); }
</style>

@code {
    private enum GameMode { MainMenu, Playing, SaveLoad, Settings }
    private GameMode currentState = GameMode.MainMenu;
    private GameMode previousState = GameMode.MainMenu;
    private bool isSaveMode = false;
    private bool isViewingQuickSave = false;

    private int textSpeed = 40;
    private int index = 0;
    private string displayedText = "";
    private string tempThumbnail = ""; 
    private bool isTyping = false;
    private CancellationTokenSource? cts;
    private Dictionary<string, SaveData> cachedSaves = new();

    public class DialogueLine { public string CharacterName { get; set; } = ""; public string Text { get; set; } = ""; }
    public class SaveData { public int CurrentIndex { get; set; } public DateTime SaveTime { get; set; } public string Thumbnail { get; set; } = ""; }

    private List<DialogueLine> script = new() {
        new() { CharacterName = "ç³»çµ±", Text = "æ­£åœ¨è¼‰å…¥ç©©å®šç‰ˆæ¸²æŸ“å¼•æ“ 3.0..." },
        new() { CharacterName = "ç³»çµ±", Text = "æˆªåœ–ç³»çµ±å·²å„ªåŒ–ï¼Œç¾åœ¨èƒŒæ™¯æ‡‰è©²æ˜¯æ·±è—è‰²ã€‚" },
        new() { CharacterName = "æ¸¬è©¦å“¡", Text = "é€™æ˜¯ç”¨ä¾†æ¸¬è©¦çš„æ–‡å­— 11111 - æˆªåœ–æ‡‰è©²åŒ…å«é€™å€‹å°è©±æ¡†ã€‚" },
        new() { CharacterName = "æ¸¬è©¦å“¡", Text = "é€™æ˜¯ç”¨ä¾†æ¸¬è©¦çš„æ–‡å­— 22222 - è«‹é€²å…¥ Save é é¢ã€‚" },
        new() { CharacterName = "æ¸¬è©¦å“¡", Text = "é€™æ˜¯ç”¨ä¾†æ¸¬è©¦çš„æ–‡å­— 33333 - ç¢ºèª Q.Save å€å¡Šç„¡æ³•æ‰‹å‹•é»æ“Šã€‚" },
        new() { CharacterName = "æ¸¬è©¦å“¡", Text = "é€™æ˜¯ç”¨ä¾†æ¸¬è©¦çš„æ–‡å­— 44444 - æ¸¬è©¦ Q.Save æŒ‰éˆ•åŠŸèƒ½ã€‚" },
        new() { CharacterName = "æ¸¬è©¦å“¡", Text = "é€™æ˜¯ç”¨ä¾†æ¸¬è©¦çš„æ–‡å­— 55555 - æ¸¬è©¦çµæŸã€‚" }
    };

    private DialogueLine currentLine => script.Count > index ? script[index] : new();

    private async Task OpenSaveLoadPage(bool viewingQuick) {
        previousState = currentState;
        isSaveMode = false;
        isViewingQuickSave = viewingQuick;
        await RefreshSaveCache();
        currentState = GameMode.SaveLoad;
    }

    private async Task OpenSaveLoadInGame(bool saving, bool viewingQuick) {
        if (currentState == GameMode.Playing) {
            try {
                // ç­‰å¾… 50ms ç¢ºä¿ DOM æ¸²æŸ“å®Œæˆå¾Œå†æˆªåœ–
                await Task.Delay(50);
                tempThumbnail = await JSRuntime.InvokeAsync<string>("captureThumbnail", ".capture-target");
            } catch { tempThumbnail = ""; }
        }
        previousState = currentState;
        isSaveMode = saving;
        isViewingQuickSave = viewingQuick;
        await RefreshSaveCache();
        currentState = GameMode.SaveLoad;
    }

    private void CloseSubPage() => currentState = previousState;

    private async Task HandleSlotClick(int slot, bool isQuick) {
        if (isSaveMode && isQuick) return; // ç¦æ­¢æ‰‹å‹•å­˜ Q å€

        string key = $"MyVN_{(isQuick ? "Quick" : "Normal")}_{slot}";
        if (isSaveMode) await ExecuteSave(key);
        else await ExecuteLoad(key.Replace("MyVN_", ""));
    }

    private async Task ExecuteSave(string storageKey) {
        string thumb = (currentState == GameMode.Playing) ? 
            await GetLiveThumbnail() : tempThumbnail;

        try {
            var data = new SaveData { CurrentIndex = index, SaveTime = DateTime.Now, Thumbnail = thumb };
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", storageKey, JsonSerializer.Serialize(data));
            await RefreshSaveCache();
        } catch { }
    }

    private async Task<string> GetLiveThumbnail() {
        try { return await JSRuntime.InvokeAsync<string>("captureThumbnail", ".capture-target"); } 
        catch { return ""; }
    }

    private async Task ExecuteLoad(string cacheKey) {
        if (cachedSaves.TryGetValue(cacheKey, out var data)) {
            index = data.CurrentIndex;
            displayedText = currentLine.Text;
            isTyping = false;
            currentState = GameMode.Playing;
        }
    }

    private async Task PerformQuickSave() {
        await RefreshSaveCache();
        int targetSlot = -1;
        // å„ªå…ˆæ‰¾ç©ºä½
        for (int i = 1; i <= 12; i++) { if (!HasData(i, true)) { targetSlot = i; break; } }
        // æ²’ç©ºä½æ‰¾æœ€èˆŠçš„
        if (targetSlot == -1) {
            DateTime oldest = DateTime.MaxValue;
            for (int i = 1; i <= 12; i++) {
                var d = GetSlotData(i, true);
                if (d != null && d.SaveTime < oldest) { oldest = d.SaveTime; targetSlot = i; }
            }
        }
        if (targetSlot != -1) await ExecuteSave($"MyVN_Quick_{targetSlot}");
    }

    private async Task PerformQuickLoad() {
        await RefreshSaveCache();
        DateTime newest = DateTime.MinValue;
        int targetSlot = -1;
        // æ‰¾æœ€æ–°çš„
        for (int i = 1; i <= 12; i++) {
            var d = GetSlotData(i, true);
            if (d != null && d.SaveTime > newest) { newest = d.SaveTime; targetSlot = i; }
        }
        if (targetSlot != -1) await ExecuteLoad($"Quick_{targetSlot}");
    }

    private async Task RefreshSaveCache() {
        cachedSaves.Clear();
        for (int i = 1; i <= 12; i++) {
            var n = await JSRuntime.InvokeAsync<string>("localStorage.getItem", $"MyVN_Normal_{i}");
            if (!string.IsNullOrEmpty(n)) cachedSaves[$"Normal_{i}"] = JsonSerializer.Deserialize<SaveData>(n)!;
            var q = await JSRuntime.InvokeAsync<string>("localStorage.getItem", $"MyVN_Quick_{i}");
            if (!string.IsNullOrEmpty(q)) cachedSaves[$"Quick_{i}"] = JsonSerializer.Deserialize<SaveData>(q)!;
        }
    }

    private SaveData? GetSlotData(int slot, bool isQuick) => cachedSaves.GetValueOrDefault($"{(isQuick ? "Quick" : "Normal")}_{slot}");
    private bool HasData(int slot, bool isQuick) => cachedSaves.ContainsKey($"{(isQuick ? "Quick" : "Normal")}_{slot}");

    private async Task StartNewGame() { index = 0; currentState = GameMode.Playing; await TypeCurrentLine(); }
    private void BackToMenu() => currentState = GameMode.MainMenu;
    private void SwitchState(GameMode s) { previousState = currentState; currentState = s; }

    private async Task HandleGlobalClick() {
        if (currentState != GameMode.Playing) return;
        if (isTyping) cts?.Cancel();
        else if (index < script.Count - 1) { index++; await TypeCurrentLine(); }
        else BackToMenu();
    }

    private async Task TypeCurrentLine() {
        string fullText = currentLine.Text;
        displayedText = ""; isTyping = true;
        cts?.Cancel(); cts = new();
        try {
            foreach (var ch in fullText) {
                displayedText += ch; StateHasChanged();
                await Task.Delay(textSpeed, cts.Token);
            }
        } catch { displayedText = fullText; } finally { isTyping = false; StateHasChanged(); }
    }

    private async Task QuitGame() => await JSRuntime.InvokeVoidAsync("location.assign", "https://github.com/");
}
