@page "/"
@using System.Threading
@using System.Text.Json
@inject IJSRuntime JSRuntime

@* 視覺小說主控畫布 (Master Canvas) 
    整合功能：主選單、打字機對話系統、24格存檔系統 (分頁切換)、Q.Save 自動覆蓋邏輯
    修正說明：
    1. 增加 @onclick:stopPropagation 於關閉按鈕，防止點擊穿透導致對話自動跳行。
    2. 優化 CloseSubPage 邏輯，確保回歸遊戲時文字保持完整顯示狀態。
*@

<div class="vn-container" @onclick="HandleGlobalClick" style="height: 100vh; background: #0a0a0a; color: white; user-select: none; position: relative; overflow: hidden; font-family: 'Segoe UI', Microsoft JhengHei, sans-serif;">

    @if (currentState == GameMode.MainMenu)
    {
        <!-- 1. 主選單畫面 -->
        <div class="main-menu" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('images/bg_main_menu.webp'); background-size: cover; background-position: center;">
            
            <div class="title-section" style="text-align: center; margin-bottom: 40px; animation: fadeInDown 1.5s ease-out;">
                <h1 style="font-size: 4.5rem; color: #00ffcc; text-shadow: 0 0 25px rgba(0,255,204,0.6); letter-spacing: 12px; margin: 0;">
                    宇宙邊緣的腳本家
                </h1>
                <p style="font-size: 1.2rem; color: #888; letter-spacing: 4px; margin-top: 10px;">Project: MyCSharpVN</p>
            </div>

            <div class="menu-buttons" style="display: flex; flex-direction: column; gap: 15px; width: 340px;">
                <button class="btn-menu" @onclick="StartNewGame" @onclick:stopPropagation>開始遊戲</button>
                <button class="btn-menu" @onclick="() => OpenSaveLoadPage(false)" @onclick:stopPropagation>讀取進度</button>
                <button class="btn-menu" @onclick="() => SwitchState(GameMode.Settings)" @onclick:stopPropagation>遊戲設定</button>
                <button class="btn-menu" @onclick="() => SwitchState(GameMode.Gallery)" @onclick:stopPropagation>回憶畫廊</button>
                <button class="btn-menu" @onclick="QuitGame" @onclick:stopPropagation>離開遊戲</button>
            </div>
        </div>
    }
    else if (currentState == GameMode.Playing)
    {
        <!-- 2. 遊戲進行畫面 -->
        <div class="game-view" style="height: 100%; display: flex; flex-direction: column; justify-content: flex-end; background: url('images/bg_spaceship_bridge.webp'); background-size: cover; background-position: center;">
            
            <!-- 對話顯示區 -->
            <div class="dialogue-box" style="border: 2px solid #00ffcc; margin: 50px 35px 35px 35px; padding: 30px; background: rgba(0,0,0,0.88); min-height: 180px; border-radius: 12px; box-shadow: 0 0 30px rgba(0,255,204,0.2); backdrop-filter: blur(8px); position: relative;">
                
                <!-- 遊戲內選單 (HUD)：緊貼對話框右上方 -->
                <div class="game-hud" style="position: absolute; top: -45px; right: 0; display: flex; gap: 5px;">
                    <button class="btn-hud" @onclick="() => OpenSaveLoadInGame(true, false)" @onclick:stopPropagation>Save</button>
                    <button class="btn-hud" @onclick="PerformQuickSave" @onclick:stopPropagation>Q.Save</button>
                    <button class="btn-hud" @onclick="() => OpenSaveLoadInGame(false, false)" @onclick:stopPropagation>Load</button>
                    <button class="btn-hud" @onclick="PerformQuickLoad" @onclick:stopPropagation>Q.Load</button>
                    <button class="btn-hud" @onclick="BackToMenu" @onclick:stopPropagation>Menu</button>
                </div>

                <div class="char-name" style="color: #00ffcc; font-weight: bold; font-size: 1.6rem; margin-bottom: 15px; display: inline-block; border-bottom: 2px solid #00ffcc; padding-bottom: 5px;">
                    @currentLine.CharacterName
                </div>
                
                <div class="text-content" style="font-size: 1.5rem; line-height: 1.8; color: #e0e0e0; letter-spacing: 1.5px;">
                    @displayedText
                </div>
                
                <div class="next-indicator" style="position: absolute; bottom: 20px; right: 25px; color: #00ffcc; font-size: 0.9rem; animation: pulse 1.5s infinite;">
                    @(isTyping ? "▶ 跳過動畫" : "▼ 點擊繼續")
                </div>
            </div>
        </div>
    }
    else if (currentState == GameMode.SaveLoad)
    {
        <!-- 3. 讀取/存檔進度頁面 -->
        <div class="sub-page" style="display: flex; flex-direction: column; height: 100%; background: #050505; padding: 40px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="color: #00ffcc; margin: 0; font-size: 2.2rem; letter-spacing: 5px;">
                    @(isSaveMode ? (isViewingQuickSave ? "快速存檔管理" : "保存進度") : (isViewingQuickSave ? "快速讀取" : "讀取進度"))
                </h2>
                <!-- 修正點：加上 @onclick:stopPropagation 防止點擊穿透到遊戲層 -->
                <button class="btn-menu" style="width: 150px; padding: 5px;" @onclick="CloseSubPage" @onclick:stopPropagation>關閉</button>
            </div>
            
            <div style="flex-grow: 1;">
                <h3 style="color: @(isViewingQuickSave ? "#00ffcc" : "#888"); border-bottom: 1px solid #333; padding-bottom: 10px;">
                    @(isViewingQuickSave ? "QUICK SAVE SLOTS" : "NORMAL SAVE SLOTS")
                </h3>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 20px;">
                    @for (int i = 1; i <= 12; i++)
                    {
                        int slot = i;
                        <div class="save-slot @(isViewingQuickSave ? "quick" : "") @(HasData(slot, isViewingQuickSave) ? "has-data" : "")" @onclick="() => HandleSlotClick(slot, isViewingQuickSave)" @onclick:stopPropagation>
                            <div class="slot-number">@(isViewingQuickSave ? "Q#" : "#")@slot.ToString("D2")</div>
                            <div class="slot-info">@GetSlotLabel(slot, isViewingQuickSave)</div>
                        </div>
                    }
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button class="btn-tab @(!isViewingQuickSave ? "active" : "")" @onclick="() => isViewingQuickSave = false" @onclick:stopPropagation>Normal Save</button>
                <button class="btn-tab @(isViewingQuickSave ? "active" : "")" @onclick="() => isViewingQuickSave = true" @onclick:stopPropagation>Quick Save</button>
            </div>
        </div>
    }
    else
    {
        <div class="sub-page" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: #111;">
            <h2 style="color: #00ffcc; margin-bottom: 30px;">@currentState 頁面開發中...</h2>
            <button class="btn-menu" style="width: 200px;" @onclick="CloseSubPage" @onclick:stopPropagation>返回</button>
        </div>
    }

</div>

<style>
    .btn-menu { background: rgba(0, 255, 204, 0.03); border: 1px solid rgba(0, 255, 204, 0.4); color: #fff; padding: 14px; font-size: 1.25rem; cursor: pointer; transition: 0.3s; text-transform: uppercase; letter-spacing: 2px; backdrop-filter: blur(4px); text-align: center; }
    .btn-menu:hover { background: #00ffcc; color: #000; box-shadow: 0 0 15px #00ffcc; }
    .btn-hud { background: rgba(0, 0, 0, 0.7); border: 1px solid #00ffcc; color: #00ffcc; padding: 5px 12px; font-size: 0.85rem; cursor: pointer; transition: 0.2s; border-radius: 4px 4px 0 0; }
    .btn-hud:hover { background: #00ffcc; color: #000; }
    .btn-tab { background: #111; border: 1px solid #333; color: #666; padding: 10px 20px; cursor: pointer; transition: 0.3s; }
    .btn-tab.active { border-color: #00ffcc; color: #00ffcc; background: rgba(0, 255, 204, 0.1); }
    .save-slot { background: #111; border: 1px solid #333; padding: 15px; cursor: pointer; transition: 0.2s; min-height: 80px; display: flex; flex-direction: column; justify-content: center; border-radius: 4px; }
    .save-slot:hover { border-color: #eee; background: #1a1a1a; }
    .save-slot.quick { border-color: #003322; }
    .save-slot.quick:hover { border-color: #00ffcc; background: #001100; }
    .save-slot.has-data { background: #1a1a1a; border-left: 4px solid #888; }
    .save-slot.quick.has-data { border-left: 4px solid #00ffcc; }
    .slot-number { font-size: 0.75rem; color: #555; margin-bottom: 6px; }
    .slot-info { font-size: 0.9rem; color: #888; }
    .save-slot.has-data .slot-info { color: #ccc; }
    @@keyframes pulse { 0% { opacity: 0.3; transform: translateY(0); } 50% { opacity: 1; transform: translateY(-3px); } 100% { opacity: 0.3; transform: translateY(0); } }
    @@keyframes fadeInDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
</style>

@code {
    private enum GameMode { MainMenu, Playing, SaveLoad, Settings, Gallery }
    private GameMode currentState = GameMode.MainMenu;
    private GameMode previousState = GameMode.MainMenu;
    private bool isSaveMode = false;
    private bool isViewingQuickSave = false;

    public class DialogueLine {
        public string CharacterName { get; set; } = "";
        public string Text { get; set; } = "";
    }

    public class SaveData {
        public int CurrentIndex { get; set; }
        public DateTime SaveTime { get; set; }
    }

    private int index = 0;
    private string displayedText = "";
    private bool isTyping = false;
    private CancellationTokenSource? cts;
    private Dictionary<string, SaveData> cachedSaves = new();

    private List<DialogueLine> script = new List<DialogueLine> {
        new DialogueLine { CharacterName = "系統", Text = "正在重新校準界面協議..." },
        new DialogueLine { CharacterName = "主角", Text = "這才是真正的視覺小說配置。Q.Save 已經準備就緒。" },
        new DialogueLine { CharacterName = "AI 助手", Text = "我會負責監控 12 個快速存檔槽位，自動覆蓋最舊的資料。" },
        new DialogueLine { CharacterName = "系統", Text = "HUD 位置已修正，分頁系統上線。" },
        new DialogueLine { CharacterName = "系統", Text = "這是用來測試的文字11111。" },
        new DialogueLine { CharacterName = "系統", Text = "這是用來測試的文字22222。" },
        new DialogueLine { CharacterName = "系統", Text = "這是用來測試的文字33333。" },
        new DialogueLine { CharacterName = "系統", Text = "這是用來測試的文字44444。" },
        new DialogueLine { CharacterName = "系統", Text = "這是用來測試的文字55555。" }
    };

    private DialogueLine currentLine => script.Count > index ? script[index] : new DialogueLine();

    // --- 存檔/讀取邏輯 ---

    private async Task OpenSaveLoadPage(bool viewingQuick) {
        previousState = currentState;
        isSaveMode = false;
        isViewingQuickSave = viewingQuick;
        await RefreshSaveCache();
        SwitchState(GameMode.SaveLoad);
    }

    private async Task OpenSaveLoadInGame(bool saving, bool viewingQuick) {
        previousState = currentState;
        isSaveMode = saving;
        isViewingQuickSave = viewingQuick;
        await RefreshSaveCache();
        SwitchState(GameMode.SaveLoad);
    }

    private void CloseSubPage() {
        // 修正點：回到遊戲時，強制讓文字填滿當前劇本內容，且標記為非打字狀態
        if (previousState == GameMode.Playing) {
            displayedText = currentLine.Text;
            isTyping = false;
        }
        currentState = previousState;
    }

    private async Task PerformQuickSave() {
        await RefreshSaveCache();
        int targetSlot = -1;
        for (int i = 1; i <= 12; i++) {
            if (!HasData(i, true)) { targetSlot = i; break; }
        }
        if (targetSlot == -1) {
            DateTime oldestTime = DateTime.MaxValue;
            for (int i = 1; i <= 12; i++) {
                if (cachedSaves.TryGetValue($"Quick_{i}", out var data) && data.SaveTime < oldestTime) {
                    oldestTime = data.SaveTime;
                    targetSlot = i;
                }
            }
        }
        if (targetSlot != -1) { await ExecuteSave($"MyVN_Quick_{targetSlot}"); }
    }

    private async Task PerformQuickLoad() {
        await RefreshSaveCache();
        DateTime newestTime = DateTime.MinValue;
        int targetSlot = -1;
        for (int i = 1; i <= 12; i++) {
            if (cachedSaves.TryGetValue($"Quick_{i}", out var data) && data.SaveTime > newestTime) {
                newestTime = data.SaveTime;
                targetSlot = i;
            }
        }
        if (targetSlot != -1) { await ExecuteLoad($"Quick_{targetSlot}"); }
        else { await OpenSaveLoadPage(true); }
    }

    private async Task ExecuteSave(string key) {
        var data = new SaveData { CurrentIndex = index, SaveTime = DateTime.Now };
        await JSRuntime.InvokeVoidAsync("localStorage.setItem", key, JsonSerializer.Serialize(data));
        await RefreshSaveCache();
    }

    private async Task ExecuteLoad(string cacheKey) {
        if (cachedSaves.TryGetValue(cacheKey, out var data)) {
            index = data.CurrentIndex;
            displayedText = currentLine.Text; // 讀檔時直接顯示全文
            isTyping = false;
            currentState = GameMode.Playing;
            StateHasChanged();
        }
    }

    private async Task RefreshSaveCache() {
        cachedSaves.Clear();
        for (int i = 1; i <= 12; i++) {
            var normalJson = await JSRuntime.InvokeAsync<string>("localStorage.getItem", $"MyVN_Normal_{i}");
            if (!string.IsNullOrEmpty(normalJson)) cachedSaves[$"Normal_{i}"] = JsonSerializer.Deserialize<SaveData>(normalJson)!;
            var quickJson = await JSRuntime.InvokeAsync<string>("localStorage.getItem", $"MyVN_Quick_{i}");
            if (!string.IsNullOrEmpty(quickJson)) cachedSaves[$"Quick_{i}"] = JsonSerializer.Deserialize<SaveData>(quickJson)!;
        }
    }

    private bool HasData(int slot, bool isQuick) => cachedSaves.ContainsKey($"{(isQuick ? "Quick" : "Normal")}_{slot}");

    private string GetSlotLabel(int slot, bool isQuick) {
        string key = $"{(isQuick ? "Quick" : "Normal")}_{slot}";
        if (cachedSaves.TryGetValue(key, out var data)) return data.SaveTime.ToString("yyyy/MM/dd HH:mm");
        return "Empty Slot";
    }

    private async Task HandleSlotClick(int slot, bool isQuick) {
        string prefix = isQuick ? "Quick" : "Normal";
        if (isSaveMode) { await ExecuteSave($"MyVN_{prefix}_{slot}"); }
        else { await ExecuteLoad($"{prefix}_{slot}"); }
    }

    // --- 遊戲邏輯 ---

    private void SwitchState(GameMode nextState) {
        previousState = currentState;
        currentState = nextState;
    }
    
    private void BackToMenu() => currentState = GameMode.MainMenu;

    private async Task StartNewGame() {
        index = 0;
        currentState = GameMode.Playing;
        await TypeCurrentLine();
    }

    private async Task HandleGlobalClick() {
        // 如果不在遊玩狀態，或者點擊到了會阻止冒泡的 UI 元素，就不執行
        if (currentState != GameMode.Playing) return;
        
        if (isTyping) cts?.Cancel();
        else {
            if (index < script.Count - 1) { index++; await TypeCurrentLine(); }
            else BackToMenu();
        }
    }

    private async Task TypeCurrentLine() {
        string fullText = currentLine.Text;
        displayedText = "";
        isTyping = true;
        if (cts != null) { cts.Cancel(); cts.Dispose(); }
        cts = new CancellationTokenSource();
        var token = cts.Token;
        try {
            foreach (var ch in fullText) {
                if (token.IsCancellationRequested) break;
                displayedText += ch;
                StateHasChanged();
                await Task.Delay(45, token);
            }
        }
        catch (OperationCanceledException) { displayedText = fullText; }
        finally { isTyping = false; StateHasChanged(); }
    }

    private async Task QuitGame() {
        bool confirm = await JSRuntime.InvokeAsync<bool>("confirm", "確定要退出嗎？");
        if (confirm) await JSRuntime.InvokeVoidAsync("location.assign", "https://github.com/789jacobis/MyCSharpVN");
    }
}
