@page "/"
@using System.Threading
@using System.Text.Json
@inject IJSRuntime JSRuntime

@* 視覺小說主控畫布 - 穩定版 (修復存檔崩潰)
   更新內容：
   1. 新增 tempThumbnail 變數，用於暫存選單開啟前的遊戲畫面。
   2. OpenSaveLoadInGame 改為先截圖、再切換頁面。
   3. ExecuteSave 加入防呆機制，根據當前狀態決定使用即時截圖還是暫存圖。
   4. 全面加上 try-catch，防止 JavaScript 錯誤導致遊戲重啟 (Reload Bar)。
*@

<div class="vn-container" @onclick="HandleGlobalClick" style="height: 100vh; background: #0a0a0a; color: white; user-select: none; position: relative; overflow: hidden; font-family: 'Segoe UI', Microsoft JhengHei, sans-serif;">

    @if (currentState == GameMode.MainMenu)
    {
        <div class="main-menu" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('images/bg_main_menu.webp'); background-size: cover; background-position: center;">
            <div class="title-section" style="text-align: center; margin-bottom: 50px;">
                <h1 style="font-size: 4rem; color: #00ffcc; text-shadow: 0 0 20px rgba(0,255,204,0.5); letter-spacing: 10px;">
                    宇宙邊緣的腳本家
                </h1>
                <p style="color: #888; letter-spacing: 3px;">Project MyCSharpVN - Preview Mode</p>
            </div>
            <div class="menu-buttons" style="display: flex; flex-direction: column; gap: 12px; width: 300px;">
                <button class="btn-menu" @onclick="StartNewGame" @onclick:stopPropagation>開始遊戲</button>
                <button class="btn-menu" @onclick="() => OpenSaveLoadPage(false)" @onclick:stopPropagation>讀取進度</button>
                <button class="btn-menu" @onclick="() => SwitchState(GameMode.Settings)" @onclick:stopPropagation>遊戲設定</button>
                <button class="btn-menu" @onclick="QuitGame" @onclick:stopPropagation>離開遊戲</button>
            </div>
        </div>
    }
    else if (currentState == GameMode.Playing)
    {
        <div class="game-view capture-target" style="height: 100%; display: flex; flex-direction: column; justify-content: flex-end; background: url('images/bg_spaceship_bridge.webp'); background-size: cover;">
            <div class="dialogue-box" style="border: 2px solid #00ffcc; margin: 40px; padding: 25px; background: rgba(0,0,0,0.9); border-radius: 15px; position: relative; min-height: 160px;">
                <div class="game-hud" style="position: absolute; top: -42px; right: 0; display: flex; gap: 5px;">
                    <button class="btn-hud" @onclick="() => OpenSaveLoadInGame(true, false)" @onclick:stopPropagation>Save</button>
                    <button class="btn-hud" @onclick="PerformQuickSave" @onclick:stopPropagation>Q.Save</button>
                    <button class="btn-hud" @onclick="() => OpenSaveLoadInGame(false, false)" @onclick:stopPropagation>Load</button>
                    <button class="btn-hud" @onclick="PerformQuickLoad" @onclick:stopPropagation>Q.Load</button>
                    <button class="btn-hud" @onclick="BackToMenu" @onclick:stopPropagation>Menu</button>
                </div>
                <div class="char-name" style="color: #00ffcc; font-size: 1.4rem; font-weight: bold; margin-bottom: 10px;">@currentLine.CharacterName</div>
                <div class="text-content" style="font-size: 1.3rem; line-height: 1.6;">@displayedText</div>
            </div>
        </div>
    }
    else if (currentState == GameMode.SaveLoad)
    {
        <div class="sub-page" style="height: 100%; background: #050505; padding: 30px; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 25px; position: relative;">
                <div class="tab-group" style="display: flex; background: #111; padding: 5px; border-radius: 25px; border: 1px solid #333;">
                    <button class="tab-btn @(!isViewingQuickSave ? "active" : "")" @onclick="() => isViewingQuickSave = false">NORMAL LOAD</button>
                    <button class="tab-btn @(isViewingQuickSave ? "active" : "")" @onclick="() => isViewingQuickSave = true">QUICK LOAD</button>
                </div>
                <button class="btn-close" style="position: absolute; right: 0;" @onclick="CloseSubPage">✕</button>
            </div>
            <div class="save-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; flex-grow: 1;">
                @for (int i = 1; i <= 12; i++)
                {
                    int slot = i;
                    var data = GetSlotData(slot, isViewingQuickSave);
                    <div class="save-card @(data != null ? "has-data" : "")" @onclick="() => HandleSlotClick(slot, isViewingQuickSave)">
                        <div class="card-header">
                            <span>@(isViewingQuickSave ? "Q" : "")@slot.ToString("D3")</span>
                            <span class="card-time">@(data?.SaveTime.ToString("yyyy/MM/dd HH:mm:ss") ?? "EMPTY")</span>
                        </div>
                        <div class="card-thumb" style="background-image: url('@(data?.Thumbnail ?? "")'); background-size: cover;">
                            @if (data == null)
                            {
                                <div class="empty-txt">NO DATA</div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

<style>
    .btn-menu {
        background: rgba(0,255,204,0.05);
        border: 1px solid #00ffcc;
        color: #fff;
        padding: 12px;
        cursor: pointer;
        transition: 0.3s;
        letter-spacing: 2px;
    }

        .btn-menu:hover {
            background: #00ffcc;
            color: #000;
            box-shadow: 0 0 15px #00ffcc;
        }

    .btn-hud {
        background: rgba(0,0,0,0.8);
        border: 1px solid #00ffcc;
        color: #00ffcc;
        padding: 4px 10px;
        font-size: 0.8rem;
        cursor: pointer;
    }

    .tab-btn {
        background: transparent;
        border: none;
        color: #666;
        padding: 8px 20px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.85rem;
    }

        .tab-btn.active {
            background: #00ffcc;
            color: #000;
            font-weight: bold;
        }

    .save-card {
        background: #111;
        border: 1px solid #333;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        flex-direction: column;
    }

        .save-card:hover {
            border-color: #00ffcc;
            transform: scale(1.02);
        }

    .card-header {
        font-size: 0.7rem;
        padding: 4px 8px;
        background: #1a1a1a;
        display: flex;
        justify-content: space-between;
        color: #555;
    }

    .card-thumb {
        aspect-ratio: 16/9;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #000;
    }

    .empty-txt {
        color: #222;
        font-weight: bold;
    }

    .has-data .card-header {
        color: #00ffcc;
    }

    .btn-close {
        background: none;
        border: 1px solid #444;
        color: #888;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        cursor: pointer;
    }
</style>

@code {
    private enum GameMode { MainMenu, Playing, SaveLoad, Settings }
    private GameMode currentState = GameMode.MainMenu;
    private GameMode previousState = GameMode.MainMenu;
    private bool isSaveMode = false;
    private bool isViewingQuickSave = false;

    private int textSpeed = 40;
    private int index = 0;
    private string displayedText = "";
    private string tempThumbnail = ""; // 暫存縮圖變數
    private bool isTyping = false;
    private CancellationTokenSource? cts;
    private Dictionary<string, SaveData> cachedSaves = new();

    public class DialogueLine { public string CharacterName { get; set; } = ""; public string Text { get; set; } = ""; }
    public class SaveData { public int CurrentIndex { get; set; } public DateTime SaveTime { get; set; } public string Thumbnail { get; set; } = ""; }

    private List<DialogueLine> script = new() {
        new() { CharacterName = "系統", Text = "正在初始化 .NET 10.0 渲染核心..." },
        new() { CharacterName = "主角", Text = "這次部署一定要成功啊，這就是最後的修正了！" },
        new() { CharacterName = "AI 助手", Text = "別擔心，我已經修正了 deploy.yml，機器人現在會抓取正確的 SDK 了。" }
    };

    private DialogueLine currentLine => script.Count > index ? script[index] : new();

    private async Task OpenSaveLoadPage(bool viewingQuick)
    {
        previousState = currentState;
        isSaveMode = false;
        isViewingQuickSave = viewingQuick;
        await RefreshSaveCache();
        currentState = GameMode.SaveLoad;
    }

    private async Task OpenSaveLoadInGame(bool saving, bool viewingQuick)
    {
        // 修正：在切換畫面「前」先截圖，避免切換後找不到遊戲畫面導致當機
        if (currentState == GameMode.Playing)
        {
            try
            {
                tempThumbnail = await JSRuntime.InvokeAsync<string>("captureThumbnail", ".capture-target");
            }
            catch { tempThumbnail = ""; }
        }

        previousState = currentState;
        isSaveMode = saving;
        isViewingQuickSave = viewingQuick;
        await RefreshSaveCache();
        currentState = GameMode.SaveLoad;
    }

    private void CloseSubPage() => currentState = previousState;

    private async Task HandleSlotClick(int slot, bool isQuick)
    {
        string key = $"MyVN_{(isQuick ? "Quick" : "Normal")}_{slot}";
        if (isSaveMode) await ExecuteSave(key);
        else await ExecuteLoad(key.Replace("MyVN_", ""));
    }

    private async Task ExecuteSave(string storageKey)
    {
        string thumb = "";

        // 判斷：如果是 Q.Save (在遊戲中)，就直接截圖
        if (currentState == GameMode.Playing)
        {
            try
            {
                thumb = await JSRuntime.InvokeAsync<string>("captureThumbnail", ".capture-target");
            }
            catch { }
        }
        else
        {
            // 如果是在選單中，就用剛剛存的那張
            thumb = tempThumbnail;
        }

        try
        {
            var data = new SaveData { CurrentIndex = index, SaveTime = DateTime.Now, Thumbnail = thumb };
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", storageKey, JsonSerializer.Serialize(data));
            await RefreshSaveCache();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Save failed: {ex.Message}");
        }
    }

    private async Task ExecuteLoad(string cacheKey)
    {
        if (cachedSaves.TryGetValue(cacheKey, out var data))
        {
            index = data.CurrentIndex;
            displayedText = currentLine.Text;
            isTyping = false;
            currentState = GameMode.Playing;
        }
    }

    private async Task PerformQuickSave()
    {
        await RefreshSaveCache();
        int slot = 1; // 簡化版：先存到 1
        await ExecuteSave($"MyVN_Quick_{slot}");
    }

    private async Task PerformQuickLoad()
    {
        await RefreshSaveCache();
        await ExecuteLoad("Quick_1");
    }

    private async Task RefreshSaveCache()
    {
        cachedSaves.Clear();
        for (int i = 1; i <= 12; i++)
        {
            var n = await JSRuntime.InvokeAsync<string>("localStorage.getItem", $"MyVN_Normal_{i}");
            if (!string.IsNullOrEmpty(n)) cachedSaves[$"Normal_{i}"] = JsonSerializer.Deserialize<SaveData>(n)!;
            var q = await JSRuntime.InvokeAsync<string>("localStorage.getItem", $"MyVN_Quick_{i}");
            if (!string.IsNullOrEmpty(q)) cachedSaves[$"Quick_{i}"] = JsonSerializer.Deserialize<SaveData>(q)!;
        }
    }

    private SaveData? GetSlotData(int slot, bool isQuick) => cachedSaves.GetValueOrDefault($"{(isQuick ? "Quick" : "Normal")}_{slot}");

    private async Task StartNewGame() { index = 0; currentState = GameMode.Playing; await TypeCurrentLine(); }
    private void BackToMenu() => currentState = GameMode.MainMenu;
    private void SwitchState(GameMode s) { previousState = currentState; currentState = s; }

    private async Task HandleGlobalClick()
    {
        if (currentState != GameMode.Playing) return;
        if (isTyping) cts?.Cancel();
        else if (index < script.Count - 1) { index++; await TypeCurrentLine(); }
        else BackToMenu();
    }

    private async Task TypeCurrentLine()
    {
        string fullText = currentLine.Text;
        displayedText = ""; isTyping = true;
        cts?.Cancel(); cts = new();
        try
        {
            foreach (var ch in fullText)
            {
                displayedText += ch; StateHasChanged();
                await Task.Delay(textSpeed, cts.Token);
            }
        }
        catch { displayedText = fullText; }
        finally { isTyping = false; StateHasChanged(); }
    }

    private async Task QuitGame() => await JSRuntime.InvokeVoidAsync("location.assign", "https://github.com/");
}