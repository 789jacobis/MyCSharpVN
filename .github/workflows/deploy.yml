name: Deploy to GitHub Pages

on:
  push:
    branches: [ master ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'

      - name: Publish app
        run: dotnet publish -c Release -o release

      - name: Universal Alias Creation (Brute Force Fix)
        # 這是最強力的修復腳本：
        # 它會掃描 _framework 資料夾，只要發現帶有「10碼指紋」的檔案
        # 就自動複製一份「沒有指紋」的替身
        # 這樣無論瀏覽器請求 dotnet.js 還是 dotnet.hash.js，都能成功！
        run: |
          cd release/wwwroot/_framework
          find . -maxdepth 1 -type f | while read filename; do
            # 使用 Regex 匹配 name.hash.ext 格式 (排除 .gz/.br 壓縮檔)
            if [[ "$filename" =~ ^\./(.*)\.([a-z0-9]{10})\.(js|json|wasm|dat)$ ]]; then
              base_name="${BASH_REMATCH[1]}"
              ext="${BASH_REMATCH[3]}"
              clean_name="$base_name.$ext"
              
              # 如果乾淨名稱的檔案不存在，就建立替身
              if [ ! -f "$clean_name" ]; then
                echo "Creating alias: $filename -> $clean_name"
                cp "$filename" "$clean_name"
              fi
            fi
          done
          
          # 額外保險：列出結果確認 dotnet.js 和 blazor.boot.json 是否存在
          ls -la | grep "dotnet.js" || true
          ls -la | grep "boot.json" || true

      - name: Fix Service Worker Integrity
        run: |
          if [ -f "release/wwwroot/service-worker-assets.js" ]; then
            sed -i 's/sha256-[^"]*//g' release/wwwroot/service-worker-assets.js || true
          fi

      - name: Force Add .nojekyll
        run: touch release/wwwroot/.nojekyll

      - name: Create 404 Page
        run: cp release/wwwroot/index.html release/wwwroot/404.html

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: release/wwwroot

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4